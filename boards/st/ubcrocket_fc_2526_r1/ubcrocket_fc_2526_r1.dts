/dts-v1/;
#include "ubcrocket_fc_2526_r1-common.dtsi"

/ {
	model = "UBC Rocket Flight Controller 2025-26 Rev 1.0";
	compatible = "ubcrocket,ubcrocket_fc_2526_r1";

	#address-cells = <1>;
	#size-cells = <1>;

	chosen {
		zephyr,console = &usart1;
		zephyr,shell-uart = &usart1;
		zephyr,sram = &sram1;
		zephyr,flash = &flash0;
		zephyr,code-partition = &slot0_partition;
	};

    leds: leds {
		compatible = "gpio-leds";

		green_led_1: led_0 {
			gpios = <&gpioa 10 GPIO_ACTIVE_HIGH>;
			label = "User LED0";
		};

        red_led_1: led_1 {
			gpios = <&gpioa 9 GPIO_ACTIVE_HIGH>;
			label = "User LD1";
		};
	};

    

	aliases {
        led0 = &green_led_1;
        led1 = &red_led_1;
        accel0 = &bmi088_accel;
        gyro0 = &bmi088_gyro;
        //imu0 = &bno085;
        baro1 = &ms5611;
        baro2 = &ms5607;
    };
};

// Enable and configure SPI2 with BMI088 sensors
&spi2 {
    status = "okay";
    //clocks = <&rcc STM32_CLOCK(APB1, 14)>, <&rcc STM32_SRC_HSI SPI2_SEL(0)>;
    pinctrl-0 = <&spi2_sck_pb10 &spi2_mosi_pc1 &spi2_miso_pc2>;
    pinctrl-names = "default";

    // Chip select pins: Accel on PD15, Gyro on PC7, Baro on PD8
    cs-gpios = <&gpiod 15 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>, <&gpioc 7 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>, <&gpiod 8 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;

    // BMI088 Accelerometer
    bmi088_accel: bmi088-accel@0 {
        status = "disabled";
        compatible = "bosch,bmi08x-accel";
        reg = <0>;
        spi-max-frequency = <10000000>;

        // Required properties:  https://docs.zephyrproject.org/latest/build/dts/api/bindings/sensor/bosch%2Cbmi08x-accel-spi.html
        accel-hz = "400";
        accel-fs = <24>;
        
        // Interrupt pins
        // int-gpios = <&gpiod 12 GPIO_ACTIVE_HIGH>;
        // int2-gpios = <&gpiod 14 GPIO_ACTIVE_HIGH>;
    };

    // BMI088 Gyroscope
    bmi088_gyro: bmi088-gyro@1 {
        status = "disabled";
        compatible = "bosch,bmi08x-gyro";
        reg = <1>;
        spi-max-frequency = <10000000>;
        
        // Required properties: https://docs.zephyrproject.org/latest/build/dts/api/bindings/sensor/bosch%2Cbmi08x-gyro-spi.html
        gyro-hz = "1000_116";
        gyro-fs = <2000>;

        // Interrupt pins
        // int-gpios = <&gpiod 11 GPIO_ACTIVE_HIGH>;
        // int4-gpios = <&gpiod 10 GPIO_ACTIVE_HIGH>;
    };

    //MS5611 Barometer (same driver as ms5607)
    ms5611: ms5611@2 {
        status = "okay";
        compatible = "meas,ms5607";
        reg = <2>;
        spi-max-frequency = <10000000>;
    };
};

&spi4 {
    status = "okay";
    pinctrl-0 = <&spi4_sck_pe12 &spi4_mosi_pe6 &spi4_miso_pe5>;
    pinctrl-names = "default";
    cs-gpios = <&gpiod 8 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>, <&gpioe 0 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
    
    ms5607: ms5607@1 {
        status = "okay";
        compatible = "meas,ms5607";
        reg = <1>;
        spi-max-frequency = <10000000>;
    };
};